<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Talia</title>
  <style>
    :root {
      --bg: #faf8f3;
      --text: #4a4a4a;
      --muted: #8b7355;
      --primary: #d4af37;
      --primary-contrast: #fff;
      --card: #fffef9;
      --border: #e8dcc0;
      --accent: #cd853f;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      position: sticky;
      position: -webkit-sticky; /* Safari support */
      top: 0;
      background-color:#8b0000 !important;
      z-index: 9999;
      width: 100%;
      min-height: 60px;
    }
    
    /* Mobile specific header fixes */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
        position: fixed !important; /* Use fixed on mobile for better compatibility */
        top: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        background: #8b0000 !important;
        width: 100vw;
        min-height: 60px;
        /* iPhone safe area support */
        padding-top: max(12px, env(safe-area-inset-top));
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
      }
      
      body {
        padding-top: calc(60px + env(safe-area-inset-top, 0px)); /* Add space for fixed header + safe area */
        background-attachment: scroll; /* Fix background on iOS */
      }
      
      main {
        margin-top: 0; /* Remove top margin on mobile */
        padding-top: 16px;
      }
    }
    
    /* iPhone 16 and newer specific fixes */
    @media (max-width: 430px) and (-webkit-min-device-pixel-ratio: 3) {
      header {
        position: fixed !important;
        top: 0 !important;
        background: #8b0000 !important;
        z-index: 99999 !important;
        transform: translateZ(0); /* Force hardware acceleration */
        -webkit-transform: translateZ(0);
      }
      
      body {
        padding-top: calc(70px + env(safe-area-inset-top, 20px));
      }
    }
    
    /* iPhone Landscape Mode Fixes */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: #8b0000 !important;
        z-index: 99999 !important;
        /* Landscape safe areas */
        
      }
      
      .cart-button {
        padding: 6px 10px !important;
        min-height: 36px !important;
        font-size: 13px !important;
      }
      
      .brand {
        font-size: 16px !important;
      }
      
      body {
        padding-top: calc(50px + env(safe-area-inset-top, 0px)) !important;
        overflow-x: hidden !important;
      }
      
      main {
        padding-top: 8px !important;
        margin-top: 0 !important;
      }
      
      .cart-panel {
        position: relative !important;
        z-index: 1000 !important;
        margin-top: 8px !important;
      }
      
      .modal-overlay {
        z-index: 100000 !important;
      }
    }
    
    /* iPhone Landscape - Specific device targeting */
    @media screen and (max-height: 500px) and (min-width: 700px) and (orientation: landscape) and (-webkit-min-device-pixel-ratio: 2) {
      header {
        position: fixed !important;
        height: 44px !important;
        min-height: 44px !important;
        padding: 6px 14px !important;
      }
      
      body {
        padding-top: calc(44px + env(safe-area-inset-top, 0px)) !important;
      }
      
      .cart-button {
        padding: 4px 8px !important;
        min-height: 32px !important;
        font-size: 12px !important;
      }
    }
    .brand { font-weight: 700; letter-spacing: 0.3px; color: white !important; }
    .cart-button {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white !important;
      padding: 12px 16px;
      border: 2px solid white;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1) !important;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      font-weight: 600;
      min-height: 44px; /* iOS touch target size */
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .cart-button:hover, .cart-button:active {
      background: rgba(255, 255, 255, 0.2) !important;
      transform: scale(0.98);
    }
    
    @media (max-width: 768px) {
      .cart-button {
        padding: 8px 12px;
        min-height: 44px;
        font-size: 14px;
      }
      
      .brand {
        font-size: 18px;
      }
    }
    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ff4444 !important;
      color: #fff !important;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 22px;
      text-align: center;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    main { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .card {
      background: rgba(255, 254, 249, 0.9);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.15), 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(212, 175, 55, 0.25), 0 4px 10px rgba(0,0,0,0.15);
    }
    .thumb {
      position: relative;
      height: 280px;
      border-radius: 10px;
      background: linear-gradient(135deg, #f5e6d3 0%, #fff8dc 30%, #f0e68c 60%, #daa520 100%);
      box-shadow: inset 0 2px 10px rgba(212, 175, 55, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 44px;
      overflow: hidden;
    }
    .image-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
      z-index: 2;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .thumb:hover .image-nav {
      opacity: 1;
    }
    .image-nav:hover {
      background: rgba(255,255,255,1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .image-nav.prev {
      left: 8px;
    }
    .image-nav.next {
      right: 8px;
    }
    .image-indicator {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .video-play-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #e8dcc0;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      transition: all 0.2s ease;
    }
    .video-play-btn:hover {
      background: rgba(0,0,0,1);
      transform: scale(1.1);
    }
    /* Video Modal Styles */
    .video-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .video-container {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: black;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-container video {
      width: 100%;
      height: 100%;
      max-height: 80vh;
    }
    .close-video {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 101;
    }
    .close-video:hover {
      background: white;
    }
    .title { font-weight: 600;text-align: right; }
    .title:hover {
      color: var(--primary);
      transition: color 0.2s ease;
    }
    .expand-icon {
      font-size: 12px;
      transition: transform 0.2s ease;
      display: inline-block;
      margin-left: 5px;
    }
    .expanded .expand-icon {
      transform: rotate(180deg);
    }
    .price { color: var(--muted); text-align: right;direction: rtl;}
    .description {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
      margin: 8px 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      text-align: right;
      direction: rtl;
      opacity: 0;
    }
    .description.expanded {
      max-height: 200px;
      overflow: visible;
      opacity: 1;
    }
    .description-toggle {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      padding: 0;
      margin: 4px 0;
      direction: rtl;
    }
    .description-toggle:hover {
      color: var(--accent);
    }
    .controls { display: flex; align-items: center; gap: 8px; }
    .qty {
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      width: '100%';
    }
    .qty button {
      background: transparent;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 18px;
    }
    .qty input {
      width: 80px;
      text-align: center;
      border: none;
      outline: none;
      padding: 8px 0;
    }
    .add-btn {
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      background: #6d071a;
      color: var(--primary-contrast);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .clear-btn {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--accent);
      color: var(--primary-contrast);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .clear-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .cart-panel {
      margin-top: 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      position: relative;
      z-index: 100;
    }
    
    @media (max-width: 768px) {
      .cart-panel {
        margin-top: 16px;
        margin-left: -16px;
        margin-right: -16px;
        border-radius: 12px 12px 0 0;
        border-left: none;
        border-right: none;
        padding: 16px;
        background: var(--card) !important;
        position: relative;
        z-index: 100;
      }
    }
    .cart-item { display: flex; justify-content: space-between; padding: 6px 0; }
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
    }
    
    @media (max-width: 768px) {
      .modal-overlay {
        z-index: 99999;
        padding: 16px;
      }
    }
    .modal {
      width: min(520px, 92vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .modal h4 { margin: 0 0 8px 0; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .secondary-btn {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .checkout-panel {
      margin-top: 24px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }
    .form-row { display: flex; flex-direction: column; gap: 6px; margin: 8px 0; }
    .form-row.two { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="email"], input[type="number"] {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      outline: none;
      background: #fffef9;
    }
    .pay-btn {
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: var(--primary-contrast);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .muted { color: var(--muted); font-size: 12px; margin-top: 6px; }
    /* Card brand selector */
    .brand-choices { display: flex; gap: 8px; align-items: center; }
    .brand-btn {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .brand-btn.selected { outline: 2px solid var(--primary); }
    .brand-logo.visa span { font-weight: 700; color: #1d4ed8; }
    .brand-logo.amex span { font-weight: 700; color: #0ea5e9; }
    .brand-logo.mc .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
    .brand-logo.mc .mc1 { background: #e11d48; }
    .brand-logo.mc .mc2 { background: #f59e0b; }
    /* Checkout bill button */
    .bill-btn {
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      background: #10b981; /* green */
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: auto;
      flex: 0 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" style="color: white;">Taluish</div>
    <button class="cart-button" id="cartButton" aria-label="Open cart">
      ðŸ›’ Cart
      <span class="cart-badge" id="cartBadge">0</span>
    </button>
  </header>
  <main>
    <section class="grid" id="productGrid" aria-label="Products"></section>
    <section class="cart-panel" id="cartPanel" aria-live="polite" aria-label="Cart summary" hidden></section>
    <section class="checkout-panel" id="checkoutPanel" aria-label="Checkout (dummy)" hidden>
      <h3>Checkout (Dummy)</h3>
      <form id="checkoutForm" novalidate>
        <div class="form-row">
          <label for="name">Full Name</label>
          <input id="name" type="text" placeholder="Jane Doe" required />
        </div>
        <div class="form-row">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="jane@example.com" required />
        </div>
        <div class="form-row">
          <label>Card Company</label>
          <div id="brandGroup" class="brand-choices" role="radiogroup" aria-label="Card company">
            <button type="button" class="brand-btn selected" data-brand="visa" role="radio" aria-checked="true" tabindex="0">
              <span class="brand-logo visa"><span>VISA</span></span>
            </button>
            <button type="button" class="brand-btn" data-brand="mastercard" role="radio" aria-checked="false" tabindex="-1">
              <span class="brand-logo mc"><span class="dot mc1"></span><span class="dot mc2"></span></span>
              <span>MasterCard</span>
            </button>
            <button type="button" class="brand-btn" data-brand="amex" role="radio" aria-checked="false" tabindex="-1">
              <span class="brand-logo amex"><span>AMEX</span></span>
            </button>
          </div>
          <div class="muted">Use test numbers: Visa 4242 4242 4242 4242, MasterCard 5555 5555 5555 4444, Amex 3782 822463 10005.</div>
        </div>
        <div class="form-row">
          <label for="card">Card Number (test)</label>
          <input id="card" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="4242 4242 4242 4242" required />
        </div>
        <div class="form-row two">
          <div>
            <label for="exp">Expiry (MM/YY)</label>
            <input id="exp" type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="12/30" required />
          </div>
          <div>
            <label for="cvc">CVC</label>
            <input id="cvc" type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="123" required />
          </div>
        </div>
        <div style="margin-top:16px; margin-bottom:16px;flex-direction: column;">
          <span >Total:</span>
          <span id="payAmount">$0.00</span>

        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-direction: row;">
          <button type="button" class="bill-btn" id="checkoutGenerateBillBtn" aria-label="Generate bill and clear cart">Pay</button>
          <button type="button" class="secondary-btn" id="checkoutCloseBtn" aria-label="Close checkout">Close</button>
        </div>
        <p class="muted">This is a dummy checkout. Do not enter real card details.</p>
      </form>
    </section>
  </main>
  
  <!-- Video Modal -->
  <div id="videoModal" class="video-modal">
    <div class="video-container">
      <button class="close-video" id="closeVideoBtn">&times;</button>
      <video id="mobileVideoPlayer" controls style="display: none;">
        <source src="https://talia-zeta.vercel.app/Mobile.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <video id="handVideoPlayer" controls style="display: none;">
        <source src="hand.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <video id="dynamicVideoPlayer" controls style="display: none;">
        <source src="" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  </div>
  
  <script>
    const products = [
      { id: 'hand', name: '×”×™×“ ×©×ª×”×¤×•×š ××ª ×”×¢×•×œ×', price: 39.90, images: ["https://talia-zeta.vercel.app/hand1.jpeg", "https://talia-zeta.vercel.app/hand2.jpeg"],video:'https://talia-zeta.vercel.app/hand.mp4', description: '×¤×¡×œ ×™×“ ×ž×“×”×™× ×‘×¢×™×¦×•×‘ ××ž× ×•×ª×™ ×™×™×—×•×“×™. ×¤×¨×™×˜ ×“×§×•×¨×˜×™×‘×™ ×ž×ž×•×©×›×™× ×œ×‘×™×ª ××• ×œ×ž×©×¨×“, ×¢×©×•×™ ×ž×—×•×ž×¨×™× ××™×›×•×ª×™×™× ×•×ž×™×•×¦×¨ ×‘×§×¤×™×“×” ×¨×‘×”.' },
      { id: 'pillow', name: '×ž×©×¤×˜ ×—×•×–×§×”', price: 24.50, images: ['https://talia-zeta.vercel.app/Stregent2.jpeg'], description: '×ž×©×¤×˜ ×—×™×–×•×§ ×•×”×©×¨××” ×ž×¢×•×¦×‘ ×‘××™×›×•×ª ×’×‘×•×”×”. ×™×—×–×§ ××ª ×”×ž×•×¨×œ ×•×™×¢× ×™×§ ×× ×¨×’×™×” ×—×™×•×‘×™×ª ×œ×‘×™×ª ××• ×œ×ž×©×¨×“.' },
      { id: 'art', name: '××ž× ×•×ª ×§×™×¨', price: 59.00, images: ['https://talia-zeta.vercel.app/Stregent1.jpeg'], description: '×™×¦×™×¨×ª ××ž× ×•×ª ×ž×™×•×—×“×ª ×œ×§×™×¨. ×¢×™×¦×•×‘ ×ž×•×“×¨× ×™ ×•××œ×’× ×˜×™ ×©×™×”×¤×•×š ×›×œ ×—×œ×œ ×œ×ž×§×•× ×ž×“×”×™× ×•×ž×©×¨×” ××•×•×™×¨×” ×™×™×—×•×“×™×ª.' },
      { id: 'lamp', name: '×ž×¢×ž×“ ×œ×ª×›×©×™×˜×™×', price: 45.00, images: ['https://talia-zeta.vercel.app/Stand1.jpeg', 'https://talia-zeta.vercel.app/Stand2.jpeg'],description:'×ž×¢×ž×“ ×™×™×—×•×“×™ ×œ×ª×›×©×™×˜×™×, ×‘×¢×™×¦×•×‘ ××œ×’× ×˜×™ ×•×ž×•×“×¨× ×™. ×¢×©×•×™ ×ž×—×•×ž×¨×™× ××™×›×•×ª×™×™×, ×”×•× ×ž×©×œ×‘ ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×¢× ××¡×ª×˜×™×§×”, ×•×ž××¤×©×¨ ×œ×š ×œ××¨×’×Ÿ ×•×œ×”×¦×™×’ ××ª ×”×ª×›×©×™×˜×™× ×©×œ×š ×‘×¦×•×¨×” ×™×¤×” ×•×ž×¡×•×“×¨×ª.' },
      { id: 'rug', name: '×ž×•×‘×™×œ ××‘× ×™×', price: 129.00, images: ['https://talia-zeta.vercel.app/Mobile1.jpeg', 'https://talia-zeta.vercel.app/Mobile2.jpeg', 'https://talia-zeta.vercel.app/Mobile3.jpeg'],video:'https://talia-zeta.vercel.app/Mobile.mp4', description: '×ž×•×‘×™×œ ××‘× ×™× ×ž×“×”×™× ×‘×¢×™×¦×•×‘ ×ž×™× ×™×ž×œ×™×¡×˜×™. ×¤×¨×™×˜ ×“×§×•×¨×˜×™×‘×™ ×™×™×—×•×“×™ ×©×ž×‘×™× ×©×œ×•×•×” ×•××œ×’× ×˜×™×•×ª ×œ×›×œ ×—×œ×œ. ×¢×©×•×™ ×ž×—×•×ž×¨×™× ×˜×‘×¢×™×™× ×•××™×›×•×ª×™×™×.' },
,
    ];

    const cart = new Map(); // id -> {product, qty}
    const productImageIndexes = new Map(); // id -> current image index
    const grid = document.getElementById('productGrid');
    const cartBadge = document.getElementById('cartBadge');
    const cartPanel = document.getElementById('cartPanel');
    const cartButton = document.getElementById('cartButton');

    function formatCurrency(n) { return 'â‚ª' + n.toFixed(2); }

    function renderProducts() {
      grid.innerHTML = '';
      products.forEach(p => {
        // Initialize image index if not exists
        if (!productImageIndexes.has(p.id)) {
          productImageIndexes.set(p.id, 0);
        }
        
        const currentImageIndex = productImageIndexes.get(p.id);
        const card = document.createElement('article');
        card.className = 'card';
        
        // Check if image is a file (contains .jpg, .png, etc.) or emoji
        const currentImage = p.images[currentImageIndex];
        const isImageFile = currentImage.includes('.jpeg') || currentImage.includes('.jpg') || currentImage.includes('.png') || currentImage.includes('.jpeg') || currentImage.includes('.gif');
        
        card.innerHTML = `
          <div class="thumb" aria-hidden="true">
            <button class="image-nav prev" aria-label="Previous image">â€¹</button>
            <div class="image-display">${isImageFile ? `<img src="${currentImage}" alt="${p.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : currentImage}</div>
            <button class="image-nav next" aria-label="Next image">â€º</button>
            <div class="image-indicator">${currentImageIndex + 1}/${p.images.length}</div>
            ${p.video ? `<button class="video-play-btn" data-video="${p.video}" aria-label="Play video" title="Play video">ðŸŽ¥</button>` : ''}
          </div>
          <div class="title" onclick="toggleDescription('${p.id}')" style="cursor: pointer;">${p.name}${p.description ? ' <span class="expand-icon">â–¼</span>' : ''}</div>
          <div class="price">${formatCurrency(p.price)}</div>
          ${p.description ? `
            <div class="description" id="desc-${p.id}">${p.description}</div>
          ` : ''}
          <div class="controls">
            <div class="qty" aria-label="Quantity selector">
              <button type="button" class="dec" aria-label="Decrease quantity">âˆ’</button>
              <input type="number" min="1" value="1" aria-label="Quantity" />
              <button type="button" class="inc" aria-label="Increase quantity">ï¼‹</button>
            </div>
            <button class="add-btn" aria-label="Add to cart">
              <span style="color: #d4af37; display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; font-size: 18px; font-weight: bold;">+</span> Add
            </button>
          </div>
        `;
        
        // Image navigation
        const prevBtn = card.querySelector('.prev');
        const nextBtn = card.querySelector('.next');
        const imageDisplay = card.querySelector('.image-display');
        const indicator = card.querySelector('.image-indicator');
        
        function updateImage() {
          const index = productImageIndexes.get(p.id);
          const image = p.images[index];
          const isImageFile = image.includes('.jpg') || image.includes('.png') || image.includes('.jpeg') || image.includes('.gif');
          
          if (isImageFile) {
            imageDisplay.innerHTML = `<img src="${image}" alt="${p.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
          } else {
            imageDisplay.textContent = image;
          }
          indicator.textContent = `${index + 1}/${p.images.length}`;
        }
        
        prevBtn.addEventListener('click', () => {
          const currentIndex = productImageIndexes.get(p.id);
          const newIndex = currentIndex === 0 ? p.images.length - 1 : currentIndex - 1;
          productImageIndexes.set(p.id, newIndex);
          updateImage();
        });
        
        nextBtn.addEventListener('click', () => {
          const currentIndex = productImageIndexes.get(p.id);
          const newIndex = currentIndex === p.images.length - 1 ? 0 : currentIndex + 1;
          productImageIndexes.set(p.id, newIndex);
          updateImage();
        });
        
        // Video play functionality
        const videoBtn = card.querySelector('.video-play-btn');
        if (videoBtn) {
          videoBtn.addEventListener('click', () => {
            playProductVideo(p.video);
          });
        }
        
        const input = card.querySelector('input');
        card.querySelector('.dec').addEventListener('click', () => {
          const v = Math.max(1, Number(input.value) - 1); input.value = v;
        });
        card.querySelector('.inc').addEventListener('click', () => {
          input.value = Number(input.value) + 1;
        });
        card.querySelector('.add-btn').addEventListener('click', () => {
          const qty = Math.max(1, Number(input.value) || 1);
          const current = cart.get(p.id) || { product: p, qty: 0 };
          current.qty += qty;
          cart.set(p.id, current);
          updateBadge();
          renderCart();
          cartPanel.hidden = false;
        });
        grid.appendChild(card);
      });
    }

    function updateBadge() {
      const totalItems = Array.from(cart.values()).reduce((sum, it) => sum + it.qty, 0);
      cartBadge.textContent = totalItems;
    }

    function renderCart() {
      const items = Array.from(cart.values());
      const total = items.reduce((sum, it) => sum + it.qty * it.product.price, 0);
      cartPanel.innerHTML = `
        <div class="cart-item" style="justify-content: space-between; align-items: center;">
          <strong>Cart</strong>
          <button class="clear-btn" id="clearCartBtn" aria-label="Clear cart" ${cart.size === 0 ? 'disabled' : ''}>ðŸ—‘ Clear Cart</button>
        </div>
        ${cart.size === 0 ? '<div class="cart-item"><span>Your cart is empty.</span><span></span></div>' : items.map(it => `
          <div class="cart-item">
            <span>${it.product.name} Ã— ${it.qty}</span>
            <span>${formatCurrency(it.qty * it.product.price)}</span>
          </div>
        `).join('')}
        <hr />
        <div class="cart-item">
          <span>Total</span>
          <span>${formatCurrency(total)}</span>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button class="add-btn" id="checkoutBtn" aria-label="Proceed to checkout" ${cart.size === 0 ? 'disabled' : ''}>Go to Checkout</button>
        </div>
      `;
      const clearBtn = document.getElementById('clearCartBtn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          if (cart.size === 0) return;
          showConfirm('Clear all items from cart?', () => {
            cart.clear();
            updateBadge();
            renderCart();
          });
        });
      }
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', () => {
          showCheckout();
        });
      }
      const genBillBtn = document.getElementById('generateBillBtn');
      if (genBillBtn) {
        genBillBtn.addEventListener('click', () => {
          showInvoiceModal();
        });
      }
    }

    function cartTotal() {
      return Array.from(cart.values()).reduce((sum, it) => sum + it.qty * it.product.price, 0);
    }

    function showCheckout() {
      const amount = cartTotal();
      document.getElementById('payAmount').textContent = formatCurrency(amount);
      checkoutPanel.hidden = false;
      cartPanel.hidden = true;
    }

    const checkoutPanel = document.getElementById('checkoutPanel');
    const checkoutForm = document.getElementById('checkoutForm');
    // Card brand selection
    const brandBtns = Array.from(document.querySelectorAll('.brand-btn'));
    let selectedCompany = 'visa';
    brandBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedCompany = btn.dataset.brand;
        brandBtns.forEach(b => {
          const sel = b === btn;
          b.classList.toggle('selected', sel);
          b.setAttribute('aria-checked', sel ? 'true' : 'false');
          b.tabIndex = sel ? 0 : -1;
        });
        const cardInput = document.getElementById('card');
        if (selectedCompany === 'visa') cardInput.placeholder = '4242 4242 4242 4242';
        else if (selectedCompany === 'mastercard') cardInput.placeholder = '5555 5555 5555 4444';
        else cardInput.placeholder = '3782 822463 10005';
      });
    });
    checkoutForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const company = selectedCompany;
      const card = document.getElementById('card').value.replace(/\s+/g, '');
      const exp = document.getElementById('exp').value.trim();
      const cvc = document.getElementById('cvc').value.trim();

      const emailOk = /.+@.+\..+/.test(email);
      const visaOk = card === '4242424242424242';
      const mcOk = card === '5555555555554444';
      const amexOk = card === '378282246310005';
      const cardOk = (company === 'visa' && visaOk) || (company === 'mastercard' && mcOk) || (company === 'amex' && amexOk);
      const expOk = /^\d{2}\/\d{2}$/.test(exp);
      const cvcOk = /^\d{3,4}$/.test(cvc);

      if (!name || !emailOk || !cardOk || !expOk || !cvcOk) {
        showAlert('Please fill valid dummy details. Use Visa 4242 4242 4242 4242, MasterCard 5555 5555 5555 4444, or Amex 3782 822463 10005.');
        return;
      }

      const btn = document.getElementById('payBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';
      setTimeout(() => {
        showAlert('Payment successful (dummy). Thank you!');
        cart.clear();
        updateBadge();
        renderCart();
        checkoutPanel.hidden = true;
        btn.disabled = false;
        btn.textContent = 'Pay ' + document.getElementById('payAmount').textContent;
      }, 800);
    });

    // Checkout panel actions
    const checkoutGenerateBillBtn = document.getElementById('checkoutGenerateBillBtn');
    if (checkoutGenerateBillBtn) {
      checkoutGenerateBillBtn.addEventListener('click', () => {
        showInvoiceModal();
      });
    }
    const checkoutCloseBtn = document.getElementById('checkoutCloseBtn');
    if (checkoutCloseBtn) {
      checkoutCloseBtn.addEventListener('click', () => {
        checkoutPanel.hidden = true;
        cartPanel.hidden = false;
      });
    }

    // Modal infrastructure
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.setAttribute('aria-hidden', 'true');
    document.body.appendChild(modalOverlay);

    function openModal(contentNode) {
      modalOverlay.innerHTML = '';
      modalOverlay.appendChild(contentNode);
      modalOverlay.style.display = 'flex';
      modalOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modalOverlay.style.display = 'none';
      modalOverlay.setAttribute('aria-hidden', 'true');
      modalOverlay.innerHTML = '';
    }

    function showConfirm(message, onConfirm) {
      const box = document.createElement('div');
      box.className = 'modal';
      box.setAttribute('role', 'dialog');
      box.setAttribute('aria-modal', 'true');
      box.innerHTML = `
        <h4>Confirm</h4>
        <p>${message}</p>
        <div class='modal-actions'>
          <button class='secondary-btn' id='cancelModalBtn'>Cancel</button>
          <button class='add-btn' id='okModalBtn'>OK</button>
        </div>
      `;
      box.querySelector('#cancelModalBtn').addEventListener('click', closeModal);
      box.querySelector('#okModalBtn').addEventListener('click', () => { closeModal(); onConfirm && onConfirm(); });
      openModal(box);
    }

    function showAlert(message) {
      const box = document.createElement('div');
      box.className = 'modal';
      box.setAttribute('role', 'dialog');
      box.setAttribute('aria-modal', 'true');
      box.innerHTML = `
        <h4>Notice</h4>
        <p>${message}</p>
        <div class='modal-actions'>
          <button class='add-btn' id='okAlertBtn'>OK</button>
        </div>
      `;
      box.querySelector('#okAlertBtn').addEventListener('click', closeModal);
      openModal(box);
    }

    function showInvoiceModal() {
      const items = Array.from(cart.values());
      const total = items.reduce((sum, it) => sum + it.qty * it.product.price, 0);
      const lines = items.map(it => `${it.product.name} x ${it.qty} = ${formatCurrency(it.qty * it.product.price)}`).join('\n');
      const invoiceText = `Invoice\n\n${lines}\n\nTotal: ${formatCurrency(total)}\nDate: ${new Date().toLocaleString()}`;
      const box = document.createElement('div');
      box.className = 'modal';
      box.setAttribute('role', 'dialog');
      box.setAttribute('aria-modal', 'true');
      box.innerHTML = `
        <h4>Invoice Preview</h4>
        <pre style='white-space: pre-wrap; background:#f9fafb; border:1px solid var(--border); padding:10px; border-radius:8px;'>${invoiceText}</pre>
        <div class='modal-actions'>
          <button class='secondary-btn' id='closeInvoiceBtn'>Close</button>
          <button class='add-btn' id='downloadInvoiceBtn'>Download & Clear</button>
        </div>
      `;
      box.querySelector('#closeInvoiceBtn').addEventListener('click', closeModal);
      box.querySelector('#downloadInvoiceBtn').addEventListener('click', () => {
        const blob = new Blob([invoiceText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoice-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        cart.clear();
        updateBadge();
        renderCart();
        checkoutPanel.hidden = true;
        cartPanel.hidden = false;
        closeModal();
      });
      openModal(box);
    }

    cartButton.addEventListener('click', () => {
      cartPanel.hidden = !cartPanel.hidden;
    });

    renderProducts();
    renderCart();
    updateBadge();
    
    // Description toggle functionality
    function toggleDescription(productId) {
      const desc = document.getElementById(`desc-${productId}`);
      const title = document.querySelector(`[onclick="toggleDescription('${productId}')"]`);
      
      if (desc && title) {
        if (desc.classList.contains('expanded')) {
          desc.classList.remove('expanded');
          title.classList.remove('expanded');
        } else {
          desc.classList.add('expanded');
          title.classList.add('expanded');
        }
      }
    }
    
    // Make toggleDescription function global
    window.toggleDescription = toggleDescription;
    
    // Video Modal Functionality
    const mobileVideoBtn = document.getElementById('mobileVideo');
    const handVideoBtn = document.getElementById('handVideo');
    const videoModal = document.getElementById('videoModal');
    const closeVideoBtn = document.getElementById('closeVideoBtn');
    const mobileVideoPlayer = document.getElementById('mobileVideoPlayer');
    const handVideoPlayer = document.getElementById('handVideoPlayer');
    const dynamicVideoPlayer = document.getElementById('dynamicVideoPlayer');
    
    let currentPlayer = null;
    
    // Close video modal function
    function closeVideoModal() {
      console.log('Closing video modal'); // Debug log
      videoModal.style.display = 'none';
      // Hide all video players
      if (mobileVideoPlayer) mobileVideoPlayer.style.display = 'none';
      if (handVideoPlayer) handVideoPlayer.style.display = 'none';
      if (dynamicVideoPlayer) dynamicVideoPlayer.style.display = 'none';
      
      if (currentPlayer) {
        currentPlayer.pause();
        currentPlayer.currentTime = 0;
        currentPlayer = null;
      }
    }
    
    // Function to play product video
    function playProductVideo(videoSrc) {
      // Hide all players
      mobileVideoPlayer.style.display = 'none';
      handVideoPlayer.style.display = 'none';
      dynamicVideoPlayer.style.display = 'none';
      
      // Set and show the appropriate player
      dynamicVideoPlayer.querySelector('source').src = videoSrc;
      dynamicVideoPlayer.style.display = 'block';
      currentPlayer = dynamicVideoPlayer;
      
      videoModal.style.display = 'flex';
      dynamicVideoPlayer.load();
    }
    
    // Open mobile video modal
    if (mobileVideoBtn) {
      mobileVideoBtn.addEventListener('click', () => {
        handVideoPlayer.style.display = 'none';
        dynamicVideoPlayer.style.display = 'none';
        mobileVideoPlayer.style.display = 'block';
        currentPlayer = mobileVideoPlayer;
        videoModal.style.display = 'flex';
        mobileVideoPlayer.load(); // Reload the video
      });
    }
    
    // Open hand video modal
    if (handVideoBtn) {
      handVideoBtn.addEventListener('click', () => {
        mobileVideoPlayer.style.display = 'none';
        dynamicVideoPlayer.style.display = 'none';
        handVideoPlayer.style.display = 'block';
        currentPlayer = handVideoPlayer;
        videoModal.style.display = 'flex';
        handVideoPlayer.load(); // Reload the video
      });
    }
    
    // Close video modal event listeners
    if (closeVideoBtn) {
      closeVideoBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Close button clicked'); // Debug log
        closeVideoModal();
      });
    }
    
    // Close video when clicking outside
    if (videoModal) {
      videoModal.addEventListener('click', (e) => {
        if (e.target === videoModal) {
          console.log('Clicked outside video'); // Debug log
          closeVideoModal();
        }
      });
    }
    
    // Close video with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && videoModal.style.display === 'flex') {
        closeVideoModal();
      }
    });
  </script>
</body>
</html>

